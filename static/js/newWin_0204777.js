"use strict";$(function(){var e=function(t){function i(t){v=t||{},b=$("#add-dialog"),x=b.find(".dialog-nav > li"),k=b.find(".grid-nav > li"),C=b.find(".tab > li"),w=b.find('input[name="url"]'),_=b.find('input[name="title"]'),q=b.find("#dialog_add_btn"),T=b.find(".dialog-grid-list"),S=b.find(".color-block-list"),I=b.find(".color-block-list > li"),y=b.find(".radio-list"),L=b.find("#grid-search-icon"),A=b.find("#grid_search_btn"),j=$("#mx_mask_layer"),"Mac"===E.platform&&C.eq(3).remove(),("Win"===E.platform&&E.max_version.cmpVersions("5.0.3.200")<0||"Mac"===E.platform&&E.max_version.cmpVersions("5.0.16")<0)&&(S.css({left:"0px",top:"70px",width:"590px"}),I.css({width:"50px",height:"50px",margin:"20px 15px 0 0px"}),b.find(".dialog-input").eq(3).css({position:"relative",top:"140px",left:"250px"}),b.find(".dialog-input").eq(1).remove(),$("<style>.color-block-list li.selected::after{background-position:-5px -65px;}</style>").appendTo("head")),x.on("click",function(){var e=$(this);e.siblings().removeClass("selected"),e.addClass("selected"),b.find("article").hide().eq(e.index()).show()}),k.on("click",function(){var e=$(this);e.siblings("li").removeClass("current"),e.addClass("current"),u(SITE_LIST[e.index()])}),C.on("click",function(){var t=$(this),i=t.index();t.siblings("li").removeClass("hover"),t.addClass("hover");var a=b.find(".main-warp > div");a.addClass("hide").eq(i).removeClass("hide"),e.clickcalls=[function(){E.useApi("common.getCurrentOpenedList",{},function(e){f(e,a.eq(i))})},function(e){E.useApi("history.getTopVisitedList",{},function(t){f(t,a.eq(e))})},function(){E.useApi(H,{},function(e){if(e.folders){var t=new treeMenu(e.folders);a.eq(i).empty().append(t.init(e.pid)),"note.getFoldersTree"!==H&&h("00000001-0000-0000-0000-000000000000",function(e){a.eq(i).append(e)})}})},function(){E.useApi("getLastOpenList",{},function(e){f(e,a.eq(i))})}],-1!=i&&e.clickcalls[i].call(this,i)}),w.on("init",function(){var e=w.val().trim();if(0!==e.length){w.removeClass("error"),b.find(".error").hide();var t=d()?!1:!0;if(e.startWith("mx://note/?id"))return w.attr("disabled","disabled"),void m({recommendlogo:{disable:!0},screenshot:{disable:!0},colorblock:{disable:!1,checked:!0}},t);w.removeAttr("disabled").removeAttr("style");var i=g(e);if(""===i)m({recommendlogo:{disable:!0},screenshot:{disable:!1,checked:!0},colorblock:{disable:!1}},t);else{W=i;var a={recommendlogo:{disable:!1,checked:!0},screenshot:{disable:!1},colorblock:{disable:!1}};m(a,t)}}}).on("blur",function(){$(this).trigger("init")}).on("focus",function(){$(this).removeClass("error")}),b.on("click",".main-warp li:not(.folder) > a",function(e){e.preventDefault(),e.stopPropagation();var t=$(this);return _.val(t.attr("title")),w.val(t.attr("href")).trigger("init"),C.each(function(e,t){return $(t).hasClass("hover")?(B=["currentlyOpen","mostVisited","maxnote","lastSession"][e],!1):void 0}),F="maxnote"===B?"1"!==t.attr("et")?"record":"website":void 0,!1}),b.on("click",".main-warp li.folder",function(){var e=$(this);e.toggleClass("open");var t=e.attr("uuid");return h(t,function(t){e.find(">ul").find("li:not(.folder)").remove().end().append(t)}),!1}),b.on("mouseover mouseout",".main-warp .menu-head,.main-warp .jstree-note",function(e){e.stopPropagation(),"mouseover"==e.type?$(this).siblings(".jstree-wholerow").show():"mouseout"==e.type&&$(this).siblings(".jstree-wholerow").hide()}),T.on("click","> li",function(e){e.preventDefault();var t=$(this);if(!t.hasClass("disable")){t.addClass("disable");var i=t.find("a"),a={title:i.attr("d-title"),url:i.attr("href"),image:i.attr("d-image"),sq_img:i.attr("d-sq-img"),sq_md5sum:i.attr("d-sq-md5"),re_img:i.attr("d-re-img"),re_md5sum:i.attr("d-re-md5"),isHot:!1};setTimeout(function(){var e=t.clone(),i=(t.width(),t.innerHeight(),t.offset());e.css({position:"absolute","-webkit-transition":"all 0.3s",left:i.left,top:i.top+document.body.scrollTop}),document.body.appendChild(e[0]);var o=Controller.getGridItem(U).grid;a.index=U,o.isHot===!0&&(a.isHot=!0);var s=d();if(!s){var n=o.isHot===!0?Math.min(o.topuiindex+1,7):o.uiindex+1,l=o.getGridPosition(n);o.node.css({left:l.left,top:l.top})}if(o.group)Controller.onUpdateGridItem(a),e&&(document.body.removeChild(e[0]),e=null);else{var c=o.getGridFixed(),m=c.left,u=c.top+document.body.scrollTop+document.documentElement.scrollTop;e.css({left:m,top:u}),setTimeout(function(){s?Controller.onUpdateGridItem(a):Controller.onInsertGridItem(a,o),e&&(document.body.removeChild(e[0]),e=null)},300)}r();var f={o:(o.isHot===!0?"top":"fav")+(s?"Edit":"Add"),m:"managesites",n:s?"edit":"add",p:"success",data:{addPosition:o.isHot===!0?o.topuiindex:o.uiindex,addSource:"default"}};datacode&&datacode.statistic(f)},50)}}),q.on("click",function(){var e=$(this);if(!e.hasClass("disable")){var t=w.val().trim(),i=_.val().trim();if(b.find(".error").hide(),0===t.length)return b.find(".error").eq(0).find(">span").html(Language.getLang("EnterUrl")).end().show(),void w.addClass("error");if(t.indexOf("..")>0&&t.indexOf(".."))return b.find(".error").eq(0).find(">span").html(Language.getLang("CheckUrl")).end().show(),void w.focus();e.addClass("disable"),0===i.length&&(i=t);var a={title:i,url:t.notUrl()?"http://"+t:t};y.each(function(e,t){var i=$(t);if(i.hasClass("selected")){switch(e){case 0:a.image=W;break;case 1:a.image=p(a.url,0);break;default:a.colorBlock=V}return!1}});var o=Controller.getGridItem(U).grid;o.isHot===!0&&(a.isHot=!0,a.image=a.image&&a.image.replace("/Re/","/Sq/"));var s={o:o.isHot===!0?"top":"fav",data:{addPosition:o.isHot===!0?o.topuiindex:o.uiindex,addSource:B||"custome"},m:"managesites"};F&&"maxnote"===B&&(s.data.maxnoteCategory=F),d()?(s.n="edit",s.o+="Edit",a.index=U,Controller.onUpdateGridItem(a)):(s.n="add",s.o+="Add",Controller.onInsertGridItem(a,o),E.useApi("common.reportLVTAction",{action:"p-mx5Newtab_addWebSite"})),r(),setTimeout(function(){s.p="success",datacode&&datacode.statistic(s)},100)}});var i;A.on("input",function(){return i&&clearTimeout(i),i=setTimeout(function(){o()},200),!1}),I.on("click",function(e){var t=$(this);e.stopPropagation(),t.parent().hasClass("disable")||(V=t.attr("class"),t.siblings().removeClass("selected").end().addClass("selected"))}),y.on("click",function(){var e=$(this),t={m:"logozoneClick"},i=e.index();switch(i){case 0:t.n="hot";break;case 1:t.n="screenshot";break;default:t.n="colorBlock"}datacode&&datacode.statistic(t),e.hasClass("disabled")||a(e)})}function a(e){var t=e.index(),i=w.val().trim();switch(i=i.notUrl()?"http://"+i:i,t){case 0:var a=g(i);""!==a&&(W=a),S.addClass("disable");break;case 1:W=p(i,0),S.addClass("disable");break;default:S.removeClass("disable"),I.removeClass("selected").siblings("."+V).addClass("selected")}e.siblings().removeClass("selected").end().addClass("selected")}function o(){var e=A.val().replace(/\s+/g,"");if(0===e.length)return void u(SITE_LIST[e.length]);for(var t={list:[]},i=0;i<SITE_LIST.length;i++)for(var a=SITE_LIST[i].list,o=0;o<a.length;o++){var s=a[o];-1===s.url.indexOf(e)&&-1===s.title.indexOf(e)||t.list.push(s)}u(t),k.removeClass("current").eq(0).addClass("current")}function s(e,t,i){var a=t?1:0,o=Language.getLang(t?"Save":"CustomAdd");b.find(".error").hide(),A.val(""),N=i,k.eq(0).click(),C.eq(0).click(),x.eq(a).click(),q.text(o),n(e),M=b.dialog({autoClose:!1,close:function(){return!1},after:function(){b.find(".close").off("click").on("click",function(){var e=Controller.getGridItem(U).grid;x.each(function(e,t){return $(t).hasClass("selected")?(B=["default","custome"][e],!1):void 0});var i={n:t?"edit":"add",o:(e.isHot===!0?"top":"fav")+(t?"Edit":"Add"),m:"managesites",p:"failure",data:{addSource:B||"custome"}};datacode&&datacode.statistic(i),r(N)})}})}function r(){var e=N;return l(),q.removeClass("disable"),w.removeAttr("disabled").removeAttr("style").removeClass("error"),y.removeClass("disabled").removeClass("selected").eq(1).addClass("selected"),I.removeClass("selected").eq(0).addClass("selected"),e===!0?(b.hide(),$group_dialog.show(),!1):void M.close()}function n(e){e=e||{},U=e.index,O=e.uiindex,D=e.title||"",P=e.url||"",W=e.image||"",V=e.colorBlock||"color-block-6",z=e.thumbType,c(),z=d()?""===W?2:W.startWith("mx://thumbs/?reflush")?1:0:1;var t={};switch(z){case 2:t.colorblock={disable:!1,checked:!0};break;case 1:t.screenshot={disable:!1,checked:!0};break;default:t.recommendlogo={disable:!1,checked:!0}}var i=g(P);""===i&&(e.image&&e.image.startWith("http://fastdail-img")||(t.recommendlogo={disable:!0})),P.startWith("mx://note/?id")&&(t.screenshot={disable:!0},w.attr("disabled","disabled")),m(t,!0)}function l(){U="",P="",D="",W="",V="",B=void 0,z=void 0,F=void 0,N=void 0}function d(){return q.text()===Language.getLang("Save")}function c(){_.val(D),w.val(P)}function m(e,t){var i=$.extend(!0,{recommendlogo:{index:0},screenshot:{index:1},colorblock:{index:2}},e);for(var o in i)if(i[o]){var s=i[o].index;i[o].disable===!0?(y.eq(s).addClass("disabled"),y.eq(s).hasClass("selected")&&(t=!0),y.eq(s).addClass("disabled")):(y.eq(s).removeClass("disabled"),y.eq(s).removeClass("disabled")),t&&i[o].checked===!0&&a(y.eq(s))}}function u(e){for(var t=[],i=0;i<e.list.length;i++){var a=e.list[i],o=[];v[a.url]&&(a.sq_img=v[a.url].sq_img||"",a.sq_img&&""!==a.sq_img&&o.push('d-sq-img="'+a.sq_img+'" '),a.re_img=v[a.url].re_img||"",a.re_img&&""!==a.re_img&&o.push('d-re-img="'+a.re_img+'" '),a.re_md5sum=v[a.url].re_md5sum||"",a.re_md5sum&&""!==a.re_md5sum&&o.push('d-re-md5="'+a.re_md5sum+'" '),a.sq_md5sum=v[a.url].sq_md5sum||"",a.sq_md5sum&&""!==a.sq_md5sum&&o.push('d-sq-md5="'+a.sq_md5sum+'" ')),a=grid.tranData(a),t.push("<li>"),t.push('<a href="'+a.url+'" d-title="'+a.title+'" d-image="'+a.image+'" '+o.join("")+' target="_blank">'),t.push('<img class="grid-img" src="'+a.image+'" width="150" height="100"/>'),t.push('<p class="grid-title">'+a.title+"</p>"),t.push("</a>"),t.push("</li>")}T.empty().append(t.join(""))}function f(e,t){for(var i=["<ul>"],a=0;a<e.length;a++){var o=e[a];i.push('<li>                        <a href="'+o.url+'" title="'+o.title+'">                            <img src="mx://favicon/'+o.url+'" alt="'+o.title+'" height="16" width="16" onerror="this.src=\''+staticServer+'/img/icon/6000.png\'" class="nav-icon" />                            <span class="nav-text">'+o.title+"</span>                        </a>                        </li>")}i.push("</ul>"),t.empty().append(i.join(""))}function h(e,t){E.useApi(G,{pid:e},function(i){var a="",o=i.notes||i.nodes;if(o){for(var s=0;s<o.length;s++){var r=o[s]||{};a+='<li>                            <div class="jstree-wholerow"></div>                            <a class="jstree-note" href="'+(1!==r.et?"mx://note/?id="+r.uuid+"&pid="+e:r.url)+'" title="'+r.fn+'" et="'+r.et+'">                                <img src="'+(1!==r.et?staticServer+"/img/icon/note.svg":"mx://favicon/"+r.url)+'" alt="'+r.fn+'" height="16" width="16" onerror="this.src=\''+staticServer+'/img/icon/6000.png\'" class="nav-icon" />                                <span class="nav-text">'+r.fn+"</span>                            </a>                        </li>"}t&&t(a)}})}function g(e){if(0!=e.length){var t=e.notUrl()?"http://"+e:e,i=/^((https|http)?:\/\/)+[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"\"])*$/;if(!i.test(t))return"";if(/http:\/\/go.maxthon.(cn|com)\/redir\/mx(4|5)\//.test(e)){var a=e.getQueryString("f");switch(a){case"tmall":t="http://jx.tmall.com";break;case"fbmx5":t="https://www.facebook.com/maxthon";break;case"jumei":t="http://bj.jumei.com/";break;case"juhuasuan":t="https://ju.taobao.com/";break;case"meituan":t="http://bj.meituan.com/";break;case"aitaobao":t="http://ai.taobao.com/";break;case"vipshop":t="http://www.vip.com/";break;case"amazon":t="https://www.amazon.cn";break;case"gome":t="http://www.gome.com.cn/";break;default:t="http://www."+a+".com"}}var o=/.*\:\/\/([^\/]*).*/,s=t.match(o),r="",n="";if("undefined"!=typeof s&&null!=s&&(r="https://vk.com/maxthon_ru"===s[0]||"https://facebook.com/maxthon.org.ru"===s[0]||"http://maxthon.org.ru"===s[0]?s[0]:s[1]),"go.maxthon.com"===r||"go.maxthon.cn"===r)return"";e:for(var l=0;l<SITE_LIST.length;l++)for(var d=SITE_LIST[l],c=0;c<d.list.length;c++){var m=d.list[c],u=m.url;if(u.indexOf(r)>=0){n=m.image,l=SITE_LIST.length;break e}if(m.match)for(var f=0;f<m.match.length;f++){var h=m.match[f];if(h.indexOf(r)>=0){n=m.image,l=SITE_LIST.length;break e}}}return n}}function p(e,i){return 0==i?"mx://thumbs/?reflush="+i+"&stamp="+(new Date).getTime()+"&url="+e:1==t.onLine?"mx://thumbs/?reflush="+i+"&stamp="+(new Date).getTime()+"&url="+e:cdnServer+"/image/logo/Re/offline.png"}var v,b,x,k,C,w,_,q,T,S,I,y,L,A,j,E=t.Api.Maxthon,H="note.getAllFolders",G="note.getNotesByPid";"Win"===E.platform&&E.max_version.cmpVersions("5.1.4.800")>=0&&(H="note.getFoldersTree",G="note.getEntriesByPid");var U,O,P,W,D,V,z,B,F,M,N;return{init:i,getThumbsUrl:p,getImageFromUrl:g,showDialog:s}}(window);window.newWin=e});