"use strict";function makeRGB(t){return["rgb(",t,")"].join("")}function mapPalette(t){var e=[];for(var n in t)e.push(frmtPobj(n,t[n]));return e.sort(function(t,e){return e.count-t.count}),e}function fitPalette(t,e){if(t.length>e)return t.slice(0,e);for(var n=t.length-1;e-1>n;n++)t.push(frmtPobj("0,0,0",0));return t}function frmtPobj(t,e){return{name:makeRGB(t),count:e}}function calcMeanColor(t,e){e=e||{};for(var n=e.exclude||[],r=e.paletteSize||PALETTESIZE,a={},s="",o=[],i=0;i<t.length;i+=4)o[0]=t[i],o[1]=t[i+1],o[2]=t[i+2],s=o.join(","),-1===o.indexOf(void 0)&&0!==t[i+3]&&-1===n.indexOf(makeRGB(s))&&(a[s]=s in a?a[s]+1:1);var u=fitPalette(mapPalette(a),r+1);return{dominant:u[0].name,secondary:u[1].name,palette:u.map(function(t){return t.name}).slice(1)}}function calculateColorBrightness(t){var e,n,r,a=153,s=/rgb\((\d{1,3}\s*,\s*\d{1,3}\s*,\s*\d{1,3})\)/i;if("string"!=typeof t)return a;if(7==t.length)e=parseInt(t.substr(1,2),16),n=parseInt(t.substr(3,2),16),r=parseInt(t.substr(4,2),16);else{if(!s.test(t))return a;t=s.exec(t)[1].split(","),e=parseInt(t[0]),n=parseInt(t[1]),r=parseInt(t[2])}return isNaN(e)||isNaN(n)||isNaN(r)?a:Math.floor((e+n+r)/3)}var PALETTESIZE=10;onmessage=function(t){var e=calcMeanColor(t.data,{exclude:["rgb(255,255,255)","rgb(0,0,0)"]}),n=calculateColorBrightness(e.dominant);postMessage(n)};